<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" />
<link href="forSmartphone.html" rel="alternate"/>
<link href="style.css" rel="stylesheet" />
<title>なでなでうつほ</title>
<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript">
if ((navigator.userAgent.indexOf('iPhone') > 0 && 
navigator.userAgent.indexOf('iPad') == -1) ||
navigator.userAgent.indexOf('iPod') > 0 ||
navigator.userAgent.indexOf('Android') > 0) {
	location.href = 'forSmartphone.html';
}

var action_limit = 4;
var action_max = 6;


var pasted = 0;
var nadecount = 0;
var namecount = 0;
var bouryokucount = 0;
var wordcount = 0;
var isInvisibleAngry = false;
var isAnotherVisible = false;

var isSad = false;
var isAngry = false;

var isUtsuhoHasGone = false;

var isGodMode = false;

function changeToGodMode(){
	isGodMode = true;
	$('#console').css({ 'display': 'block' });
	localStorage.removeItem("browser");
	nadecount = 0;
	localStorage.setItem("isInvisibleAngry", false);
	localStorage.setItem("namecount", 0);
}

function stateChange(isResetPasted){

	if(isResetPasted == null || isResetPasted === undefined)
	{
		isResetPasted = true;
	}

	if(isResetPasted)
	{
		pasted = 0;
		isSad = false;
	}

	allUtsuhoHide();
	
	if((isInvisibleAngry && namecount > 0) || wordcount > 0 || bouryokucount > 0)
	{
		changeToEnd();
		return;
	}

	if(isAngry || namecount > 0)
	{
		if(namecount > 0)
		{
			$('#angry_yod') .css({'display': 'block'});
		}
		else
		{
			$('#angry') .css({'display': 'block'});
		}
	}
	else
	if(isSad)
	{
		if(namecount > 0)
		{
			$('#sad_yod') .css({'display': 'block'});
		}
		else
		{
			$('#sad') .css({'display': 'block'});
		}
	} else
	{
		$('#index').css({'display': 'block'});
	}

	if(nadecount >= 2 && !isAnotherVisible){
		isAnotherVisible = true;
		for(var i = 2; i <= action_limit; i++){
			var mg = (i-1)*3+'vw';
			$('#action'+i).css({'display': 'block', 'marginLeft': mg});
		}
	}
	if(nadecount >= 50 && !isInvisibleAngry)
	{
		$('#action6').css({'display': 'block', 'marginLeft': '15vw' });
	}
	
	localStorage.setItem("isInvisibleAngry", isInvisibleAngry);
	if(nadecount >= 5)
	{
		localStorage.setItem("nadecount", nadecount);
	}
	localStorage.setItem("namecount", namecount);
}

function changeToEnd(){
	allUtsuhoHide();
	for(var i = 1; i <= action_max; i++) {
		var t = '#action'+i;
		$(t).css({ 'display': 'none' });
	}
	$("#serihu").val("お空ちゃんは居なくなりました。");
	isUtsuhoHasGone = true;
	localStorage.setItem("browser", window.navigator.userAgent);
}

function changeToNade(){
	allUtsuhoHide();
	if(isInvisibleAngry || namecount > 0)
	{
		if(namecount > 0)
		{
			$('#nade_yod').css({'display': 'block'});
		}
		else
		{
			$('#nade_angry').css({'display': 'block'});
		}
	}
	else
	{
		$('#nade').css({'display': 'block'});
	}
}

function resetSad(){
	pasted = 0;
	isSad = false;
}

function action1(){
	resetSad();
	$('#_hand').css({
		'display': 'block',
		'margin-left': '-32em',
		'margin-top': '2em',
		'opacity': '0'
	});
	$('#_hand').animate({ 'marginLeft' : '0em', 'opacity' : '1'}, 'normal')
	.animate({ 'marginTop': '3em' }, {complete: function(){
		changeToNade();
	}});
	
	$('#_hand').animate({ 'marginTop': '2em' })
	.animate({ 'marginTop': '3em' })
	.animate({ 'marginTop': '2em' })
	.animate({'marginLeft': '-32em'}, {complete: function(){
		nadecount++;
		
		if(namecount <= 0)
		{
			isAngry = false;
		}
		
		stateChange();
	}});
}

function action2(){
	resetSad();
	$('#_tongue').css({
		'display': 'block',
		'margin-left': '-32em',
		'margin-top': '2em',
		'opacity': '0'
	});
	$('#_tongue').animate({ 'marginLeft' : '0em', 'opacity' : '1'}, 'normal')
	//moved center
	.animate({ 'marginTop': '1em' }, {complete: function(){
		namecount++;
		changeToNade();
	}});
	
	$('#_tongue')
	.animate({'marginLeft': '-32em'}, {complete: function(){
		stateChange();
		isAngry = isInvisibleAngry = true;
		if(!isUtsuhoHasGone)
		{
			$('#action5').css({'display': 'block', 'marginLeft': '12vw' });
		}
	}});
}

function action3(){
	resetSad();
	bouryokucount++;
	stateChange();
}

function action4(){
	resetSad();
	wordcount++;
	stateChange();
}

function action5(){
	resetSad();
	$('#_hank').css({
		'display': 'block',
		'margin-left': '-32em',
		'margin-top': '2em',
		'opacity': '0'
	});
	$('#_hank').animate({ 'marginLeft' : '0em', 'opacity' : '1'}, 'normal')
	.animate({ 'marginTop': '3em' }, {complete: function(){
		changeToNade();
	}});
	
	$('#_hank').animate({ 'marginTop': '2em' })
	.animate({ 'marginTop': '3em' })
	.animate({ 'marginTop': '2em' })
	.animate({'marginLeft': '-32em'}, {complete: function(){
		namecount = 0;
		stateChange();
		
		$('#action5').css({ 'display': 'none' });
	}});
}

function action6(){
	location.href = 'forUltraPlayers.html';
}

$(function(){
    setInterval(function(){
    
    	if(isUtsuhoHasGone) return;
    
        pasted++;
        
        if(isGodMode) pasted = 0;
        
        $('#console').val("past:"+pasted+"\r\nnadecount:"+nadecount+"\r\nisInvisibleAngry:"+isInvisibleAngry+"\r\nperocount"+namecount);
        
        if(pasted >= 30)
        {
        	allUtsuhoHide();
        	changeToEnd();
        } else
        if(pasted >= 7)
        {
        	isSad = true;
        	stateChange(false);
        }
    },1000);
});

function allUtsuhoHide(){
	$('#index').css({ 'display': 'none' });
	$('#nade').css({ 'display': 'none' });
	$('#angry_yod').css({ 'display': 'none' });
	$('#nade_yod').css({ 'display': 'none' });
	
	$('#god').css({ 'display': 'none' });
	
	$('#nade_angry').css({ 'display': 'none' });
	$('#angry').css({ 'display': 'none' });
	
	$('#sad').css({ 'display': 'none' });
	$('#sad_yod').css({ 'display': 'none' });
}

function allActionHide(){
	for(var i = 1; i <= action_max; i++)
	{
		$('#action'+i).css({ 'display': 'none' });
	}
}

function checkHasGone(){
	var v = localStorage.getItem("browser");
	return (v != undefined) && (v != null);
}

function initializeStorage(){
	var v = localStorage.getItem("isInvisibleAngry");
	isInvisibleAngry = v == null ? false : ('true' === v);
	var w = localStorage.getItem("nadecount");
	nadecount = w - 0;
	
	var x = localStorage.getItem("namecount");
	namecount = x - 0;
}

function onPageLoad(){
	initializeStorage();

	$('#console').css({ 'display': 'none' });

	$('#_hand').css({ 'display': 'none' });
	$('#_tongue').css({ 'display': 'none' });
	$('#_hank').css({ 'display': 'none' });
	
	allUtsuhoHide();
	$('#index').css({ 'display': 'block' });
	
	for (var i = 1; i <= action_max; i++) {
		var t = '#action' + i;
		$(t).css({ 'display': 'none' });
	}
	$('#action1').css({'display': 'block'});
	
	if(checkHasGone())
	{
		allUtsuhoHide();
		allActionHide();
		isUtsuhoHasGone = true;
		$("#serihu").val("リロードしたら戻ってきてくれると思いましたか？\r\nそんな甘い話はありません。");
		return;
	}
}
window.onload = onPageLoad;
</script>
</head>

<body>

<noscript>
	<div class="noscript" id="noscript">Javascript使うやつやで ONにしておいてくれや</div>
</noscript>

<section>
	<h1 id="title">なでなでうつほ</h1>
	
	<div class="actbutton" id="action1"><input class="acb" type="button" value="なでる" onClick="action1()"/></div>
	<div class="actbutton" id="action2"><input class="acb" type="button" value="なめる" onClick="action2()"/></div>
	<div class="actbutton" id="action3"><input class="acb" type="button" value="なぐる" onClick="action3()"/></div>
	<div class="actbutton" id="action4"><input class="acb" type="button" value="なじる" onClick="action4()"/></div>
	
	<div class="actbutton" id="action5"><input class="acb" type="button" value=" 拭く " onClick="action5()"/></div>
	
	<div class="actbutton" id="action6"><input class="acb" type="button" value="やめる" onClick="action6()"/></div>

	<div class="utsuho" id="index">
		<img src="imgs/Resize/index.png"/>
	</div>
	<div class="utsuho" id="nade">
		<img src="imgs/Resize/nade.png"/>
	</div>
	<div class="utsuho" id="god">
		<img src="imgs/Resize/god.png"/>
	</div>
	
	<!-- おこ -->
	<div class="utsuho" id="angry">
		<img src="imgs/Resize/angry.png"/>
	</div>
	<div class="utsuho" id="nade_angry">
		<img src="imgs/Resize/nade_angry.png"/>
	</div>
	
	<!-- 悲しい -->
	<div class="utsuho" id="sad">
		<img src="imgs/Resize/sad.png"/>
	</div>
	
	<!-- よだれ系 -->
	<div class="utsuho" id="angry_yod">
		<img src="imgs/Resize/angry_yod.png"/>
	</div>
	<div class="utsuho" id="nade_yod">
		<img src="imgs/Resize/nade_yod.png"/>
	</div>
	<div class="utsuho" id="sad_yod">
		<img src="imgs/Resize/sad_yod.png"/>
	</div>
	
	
	
	<!-- モブ -->
	<div class="utsuho" id="_hand">
		<img src="imgs/Resize/_hand.png"/>
	</div>
	<div class="utsuho" id="_tongue">
		<img src="imgs/Resize/_tongue.png"/>
	</div>
	<div class="utsuho" id="_hank">
		<img src="imgs/Resize/_hank.png"/>
	</div>
	
	<div class="phrase">
		<textarea id="serihu" cols="30" rows="3" readonly></textarea>
	</div>
	<div class="console">
		<textarea id="console" cols="30" rows="3" readonly></textarea>
	</div>
	
	<!-- GodMode Switch -->
	<a href="#GodMode" onclick="changeToGodMode();return false"><div class="godswitch"></div></a>
</section>

</body>
</html>